name: Calculate Language Statistics

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # Runs every Sunday

jobs:
  language-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Get Language Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
        run: |
          echo "Fetching repositories..."

          repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$USERNAME/repos?per_page=100" | jq -r '.[].name')

          declare -A totals

          for repo in $repos; do
            echo "Processing $repo..."
            langs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$USERNAME/$repo/languages")

            for row in $(echo "$langs" | jq -r 'to_entries[] | "\(.key)=\(.value)"'); do
              lang=$(echo $row | cut -d= -f1)
              bytes=$(echo $row | cut -d= -f2)
              totals[$lang]=$(( ${totals[$lang]:-0} + bytes ))
            done
          done

          total_bytes=0
          for value in "${totals[@]}"; do
            total_bytes=$((total_bytes + value))
          done

          echo "{" > language-stats.json
          first=true
          for lang in "${!totals[@]}"; do
            percentage=$(awk "BEGIN {printf \"%.2f\", (${totals[$lang]}/$total_bytes)*100}")
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> language-stats.json
            fi
            echo -n "  \"$lang\": $percentage" >> language-stats.json
          done
          echo "" >> language-stats.json
          echo "}" >> language-stats.json

          cat language-stats.json

      - name: Commit Results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add language-stats.json
          git commit -m "Update language statistics" || echo "No changes"
          git push
